name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y portaudio19-dev python3-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        # Install dependencies, skip PyAudio in CI (requires compilation)
        grep -v "PyAudio" requirements.txt > requirements-ci.txt || true
        pip install -r requirements-ci.txt > install.log 2>&1 || true
        # Install testing dependencies separately
        pip install pytest pytest-cov >> install.log 2>&1
        cat install.log
      continue-on-error: true

    - name: Run tests with pytest
      run: |
        # Run tests if they exist, save output to log file
        pytest --verbose --cov=. --cov-report=xml --cov-report=term > pytest.log 2>&1 || echo "Tests completed with issues"
        cat pytest.log
      continue-on-error: true

    - name: Upload test logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-python-${{ matrix.python-version }}
        path: |
          pytest.log
          install.log
          coverage.xml
        retention-days: 30

  lint:
    name: Code Quality & Linting
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 pylint mypy > lint-install.log 2>&1 || true
        cat lint-install.log
      continue-on-error: true

    - name: Check code formatting with black
      run: |
        black --check --diff . > black.log 2>&1 || echo "Black formatting check completed with issues"
        cat black.log
      continue-on-error: true

    - name: Lint with flake8
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        echo "=== Critical Errors ===" > flake8.log
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics >> flake8.log 2>&1 || true
        echo "" >> flake8.log
        echo "=== All Issues ===" >> flake8.log
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics >> flake8.log 2>&1 || true
        cat flake8.log
      continue-on-error: true

    - name: Lint with pylint
      run: |
        find . -name "*.py" -type f -exec pylint {} + --exit-zero > pylint.log 2>&1 || echo "Pylint completed"
        cat pylint.log
      continue-on-error: true

    - name: Upload lint logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: lint-logs
        path: |
          lint-install.log
          black.log
          flake8.log
          pylint.log
        retention-days: 30

  security:
    name: Security Checks
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety > security-install.log 2>&1 || true
        cat security-install.log
      continue-on-error: true

    - name: Run bandit security scan
      run: |
        echo "Running bandit security scan..." > bandit.log
        bandit -r . -f json -o bandit-report.json >> bandit.log 2>&1 || true
        echo "" >> bandit.log
        echo "=== Bandit Screen Output ===" >> bandit.log
        bandit -r . -f screen >> bandit.log 2>&1 || echo "Bandit scan completed"
        cat bandit.log
      continue-on-error: true

    - name: Check dependencies for known vulnerabilities
      run: |
        echo "Running safety vulnerability check..." > safety.log
        safety check --json > safety-report.json 2>&1 || true
        echo "" >> safety.log
        echo "=== Safety Screen Output ===" >> safety.log
        safety check >> safety.log 2>&1 || echo "Safety check completed"
        cat safety.log
      continue-on-error: true

    - name: Upload security reports (always)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          bandit.log
          safety-report.json
          safety.log
          security-install.log
        retention-days: 30

    - name: Upload security logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: security-failure-logs
        path: |
          bandit.log
          safety.log
          security-install.log
        retention-days: 30

  commit-logs:
    name: Commit CI Logs to Branch
    runs-on: ubuntu-latest
    needs: [test, lint, security]
    if: github.event_name == 'pull_request' && always()
    permissions:
      contents: write

    steps:
    - name: Checkout code with full history
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Download test artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: test-logs-*
        path: ci-logs/
        merge-multiple: true
      continue-on-error: true

    - name: Download lint artifacts
      uses: actions/download-artifact@v4
      with:
        name: lint-logs
        path: ci-logs/
      continue-on-error: true

    - name: Download security artifacts
      uses: actions/download-artifact@v4
      with:
        name: security-reports
        path: ci-logs/
      continue-on-error: true

    - name: Create CI logs summary
      run: |
        cat > ci-logs/README.md << 'EOF'
        # CI Automated Check Results

        Generated: $(date -u)
        Workflow Run: ${{ github.run_number }}
        Commit: ${{ github.sha }}

        ## üìä Results Summary

        - **Tests**: ${{ needs.test.result }}
        - **Lint**: ${{ needs.lint.result }}
        - **Security**: ${{ needs.security.result }}

        ## üì¶ Available Logs

        Check the files in this directory for detailed output from each CI job.

        - `pytest.log` - Test results
        - `black.log` - Code formatting issues
        - `flake8.log` - Linting results
        - `pylint.log` - Code quality
        - `bandit.log` - Security scan
        - `safety.log` - Dependency vulnerabilities

        ## üîÑ Auto-Generated

        These logs are automatically committed by the CI workflow.
        Pull the branch to review them locally: `git pull`
        EOF

    - name: Configure git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Commit logs (amend to avoid spam)
      run: |
        # Force add ci-logs even if files match .gitignore patterns
        git add -f ci-logs/ || true
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          # Check if ci-logs already exists in last commit
          if git show HEAD:ci-logs/README.md > /dev/null 2>&1; then
            echo "Updating existing CI logs"
            git commit --amend --no-edit
          else
            echo "Adding CI logs for first time"
            git commit -m "Add CI check logs (auto-generated)"
          fi
        fi

    - name: Push logs back to branch
      run: |
        git push --force-with-lease origin ${{ github.head_ref }}
      continue-on-error: true

  all-checks-pass:
    name: All CI Checks Passed
    runs-on: ubuntu-latest
    needs: [test, lint, security, commit-logs]
    if: always()

    steps:
    - name: Check if all jobs completed
      run: |
        echo "üìä CI Check Results:"
        echo "  Test: ${{ needs.test.result }}"
        echo "  Lint: ${{ needs.lint.result }}"
        echo "  Security: ${{ needs.security.result }}"
        echo "  Commit Logs: ${{ needs.commit-logs.result }}"
        echo ""

        # For initial rollout, pass if jobs completed (even with errors)
        # This provides feedback without blocking PRs
        # To make this stricter, change "!= 'cancelled'" to "== 'success'"
        if [[ "${{ needs.test.result }}" != "cancelled" && \
              "${{ needs.lint.result }}" != "cancelled" && \
              "${{ needs.security.result }}" != "cancelled" ]]; then
          echo "‚úÖ CI checks completed! Review logs for any issues."
          echo "üí° Note: CI is currently informational. See .github/BRANCH_PROTECTION.md to enforce."
          echo "üì• Logs committed to branch - run 'git pull' to review them."
          exit 0
        else
          echo "‚ùå Some CI checks were cancelled"
          exit 1
        fi
